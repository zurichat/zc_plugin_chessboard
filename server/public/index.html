<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Centrifugo Client</title>

  <link rel="stylesheet" href="https://getbootstrap.com/docs/5.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
</head>

<body onresize="board.resize()">

  <div class="container">

    <div class="p-5 my-4 bg-light rounded-3">
      <div class="container-fluid py-5">
        <h1 class="display-5 fw-bold">Chess Plugin Tester</h1>
        <p class="col-md-8 fs-4">Here contains implementation of backend Endpoints with Centrifugo, to make frontend
          work easier</p>
        <button class="btn btn-primary btn-lg" onclick="createGame()" id="create_game_btn">Create a Game</button>
        <form class="input-group mt-3" action="javascript:void(0)" id="join_game_room_form" onsubmit="joinGame()">
          <input type="text" class="form-control" placeholder="Enter Game Room ID" id="join_game_room_input_id">
          <button class="btn btn-outline-secondary">Join</button>
        </form>
      </div>
      <div class="container-fluid py-3">
        <p class="fs-4"> Game ID: <span id="game_id"></span> </p>
        <div id="room_updates">
          <h2>Updates</h2>
          <p>Hi Updates from the game room come up here</p>
        </div>
      </div>
      <div class="container-fluid row py-3" id="chess_section" style="visibility: hidden;">
        <h2>Chess Board</h2>
        <div class="col-md-6">
          <div id="chess_board" style="width: 100%"></div>
        </div>
        <div class="col-md-6">
          <h3>Game Status:</h3>
          <p id="status"></p>
          <h3>FEN:</h3>
          <p id="fen"></p>
          <h3>PGN:</h3>
          <p id="pgn"></p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/centrifugal/centrifuge-js@2.X.X/dist/centrifuge.min.js"></script>
</body>
<script>
  // Chess Game Logic
  const game = new Chess();

  const removeGreySquares = () => {
    document.querySelectorAll('#chess_board .square-55d63').forEach(el => {
      el.style.background = '';
    });
  }

  const addGreySquares = (square) => {
    const square_box_element = document.querySelector('#chess_board .square-' + square);
    let background = "#a9a9a9";
    if (square_box_element.classList.contains('black-3c85d')) {
      background = "#696969";
    }
    square_box_element.style.background = background;
  }

  const onDragStart = (source, piece, position, orientation) => {
    // do not pick up pieces if the game is over
    // or if it's not that side's turn
    if (game.game_over() === true || (game.turn() === 'w' && piece.search(/^b/) !== -1) || (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
      return false;
    }
  }

  const onDrop = (source, target) => {
    removeGreySquares();

    // see if the move is legal
    const move = game.move({
      from: source,
      to: target,
      // NOTE: promote to a queen for example simplicity
      promotion: 'q'
    });

    // illegal move
    if (move === null) {
      return 'snapback';
    } else {
      // Send the move to server via API
      updateMove(move);
    }
    updateStatus();
  }

  const onMouseoverSquare = (square, piece) => {
    // get list of possible moves for this square
    let moves = game.moves({
      square: square,
      verbose: true
    });

    // exit if there are no moves available for this square
    if (moves.length === 0) return

    // highlight the square they moused over
    addGreySquares(square);

    // highlight the possible squares for this piece
    for (let i = 0; i < moves.length; i++) {
      addGreySquares(moves[i].to);
    }
  }

  const onMouseoutSquare = (square, piece) => {
    removeGreySquares();
  }

  // update the board position after the piece snap
  const onSnapEnd = () => {
    board.position(game.fen());
  }

  const updateStatus = () => {
    let status = ''

    let moveColor = 'White'
    if (game.turn() === 'b') {
      moveColor = 'Black';
    }

    // checkmate?
    if (game.in_checkmate()) {
      status = 'Game over, ' + moveColor + ' is in checkmate.';
    }

    // draw?
    else if (game.in_draw()) {
      status = 'Game over, drawn position';
    }

    // game still on
    else {
      status = moveColor + ' to move';

      // check?
      if (game.in_check()) {
        status += ', ' + moveColor + ' is in check';
      }
    }

    document.querySelector("#status").innerHTML = status;
    document.querySelector("#fen").innerHTML = game.fen();
    document.querySelector("#pgn").innerHTML = game.pgn();
  }

  // Initialise the Chess Board
  const board = Chessboard('chess_board', {
    draggable: true,
    position: 'start',
    onDragStart: onDragStart,
    onDrop: onDrop,
    onMouseoutSquare: onMouseoutSquare,
    onMouseoverSquare: onMouseoverSquare,
    onSnapEnd: onSnapEnd
  });
</script>
<script>
  let global_user_id;

  // Connect to Centrifugo
  const centrifuge = new Centrifuge(
    "wss://realtime.zuri.chat/connection/websocket"
  );

  centrifuge.connect();

  // Functions
  const createGame = async () => {
    global_user_id = "085fc3b2";
    const sample_data = {
      "user_id": global_user_id,
      "user_name": "John Player 1 Doe",
      "image_url": "string"
    }
    const response = await fetch(`/api/v1/game/create`, {
      method: "POST",
      body: JSON.stringify(sample_data),
      headers: { "Content-Type": "application/json" }
    });
    const result = await response.json();

    if (result.success) {
      const game_id = result.data.object_id;

      document.querySelector("#game_id").innerHTML = game_id;
      document.querySelector("#create_game_btn").style.display = "none";
      document.querySelector("#join_game_room_form").style.display = "none";
      document.querySelector("#chess_section").style.visibility = "visible";

      // Subsctibe to the GameID room on centrifugo
      centrifuge.subscribe(game_id, ChannelEventsListener);
    } else {
      document.querySelector("#room_updates").insertAdjacentHTML('afterend', `<p>Create Game Error: ${result.message}</p>`);
    }
  }

  const joinGame = async () => {
    global_user_id = "085fc3b2-1";
    const game_id = document.querySelector("#join_game_room_input_id").value;
    const sample_data = {
      "game_id": game_id,
      "user_id": global_user_id,
      "user_name": "John Player 2 Doe",
      "image_url": "string"
    }
    const response = await fetch(`/api/v1/game/join`, {
      method: "POST",
      body: JSON.stringify(sample_data),
      headers: { "Content-Type": "application/json" }
    });
    const result = await response.json();

    if (result.success) {
      document.querySelector("#game_id").innerHTML = game_id;
      document.querySelector("#create_game_btn").style.display = "none";
      document.querySelector("#join_game_room_form").style.display = "none";
      document.querySelector("#chess_section").style.visibility = "visible";

      // Subsctibe to the GameID room on centrifugo
      centrifuge.subscribe(game_id, ChannelEventsListener);
    } else {
      document.querySelector("#room_updates").insertAdjacentHTML('afterend', `<p>Join Game Error: ${result.message}</p>`);
    }
  }

  const updateMove = async (move) => {
    const game_id = document.querySelector("#game_id").innerHTML;
    const sample_data = {
      "user_id": global_user_id,
      "game_id": game_id,
      "position_fen": game.fen(),
      "board_state": move,
    }
    const response = await fetch(`/api/v1/game/piecemove`, {
      method: "PATCH",
      body: JSON.stringify(sample_data),
      headers: { "Content-Type": "application/json" }
    });
    const result = await response.json();

    if (result.success) {
      document.querySelector("#room_updates").innerHTML += `<p>Move Update Success</p>`;
    } else {
      document.querySelector("#room_updates").insertAdjacentHTML('afterend', `<p>Move Update Error: ${result.message}</p>`);
    }
  }

  // Centrifugo Events Listener and Handler
  const ChannelEventsListener = (ctx) => {

    const websocket = ctx;

    // Lets see what we get
    console.log(ctx);

    switch (ctx.data.event) {
      case "join_game":
        document.querySelector("#room_updates").insertAdjacentHTML('afterend', `<p>${websocket.data.player.user_name || websocket.data.spectator.user_name} Joined the game with ${websocket.data.permission} permissions</p>`);
        break;

      case "piece_moved":
        if(game.fen() == "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"){
          board.position(websocket.data.position_fen);
          // game.move(websocket.data.board_state);
        } else {
          game.move(websocket.data.board_state);
          board.position(game.fen());
        }
        updateStatus();
        document.querySelector("#room_updates").insertAdjacentHTML('afterend', `<p>opponent: ${websocket.data.user_id} made a move</p>`);
        break;

      default:
        document.querySelector("#room_updates").insertAdjacentHTML('afterend', `<p>Unhandled event recieved</p>`);
        break;
    }
  }
</script>

</html>